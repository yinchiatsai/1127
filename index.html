<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡è³¼ç´€éŒ„ç³»çµ±</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; background:#f9f9f9; }
    h1 { text-align:center; margin:1rem; }
    .container { display:flex; flex-direction:row; height:calc(100vh - 80px); padding:0 1rem 1rem; gap:1rem; }
    .form-section { flex:0 0 30%; background:white; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); overflow-y:auto; height:100%; }
    .form-group { display:flex; align-items:center; margin:0.5rem 0; }
    .form-group label { width:35%; font-weight:bold; }
    .form-group input, .form-group select { flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:5px; background:#f8f8f8; }
    .form-group input::placeholder { color:#aaa; }
    form button { width:100%; padding:0.75rem; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer; margin-top:1rem; }
    .data-section { flex:1; display:flex; flex-direction:column; overflow:hidden; }
    #month-filter, #search { width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:5px; margin-bottom:0.5rem; }
    .summary { text-align:right; font-weight:bold; margin-bottom:0.5rem; }
    .record-list { flex:1; overflow-y:auto; background:white; padding:1rem; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; table-layout:fixed; word-break:break-word; }
    th, td { background:#f5f5f5; padding:0.5rem; border:1px solid #ddd; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    table th:nth-child(2), table td:nth-child(2) { white-space:normal; word-break:break-word; overflow:visible; text-overflow:clip; }
    thead th { position:sticky; top:0; background:#f0f0f0; z-index:1; }
    tbody tr:hover { background:#f1f1f1; }
  </style>
</head>
<body>
  <h1>æ¡è³¼ç´€éŒ„ç³»çµ±</h1>
  <div class="container">
    <div class="form-section">
      <form id="purchase-form">
        <div class="form-group">
          <label for="date">ğŸ“… è³¼è²·æ—¥æœŸ</label>
          <input type="date" id="date" required placeholder="é¸æ“‡è³¼è²·æ—¥æœŸ">
        </div>
        <div class="form-group">
          <label for="item">ğŸ“¦ å“é …</label>
          <input type="text" id="item" list="item-list" required placeholder="è¼¸å…¥å“é …åç¨±">
          <datalist id="item-list"></datalist>
        </div>
        <div class="form-group">
          <label for="quantity">ğŸ”¢ æ•¸é‡</label>
          <input type="number" id="quantity" required placeholder="è¼¸å…¥æ•¸é‡ï¼ˆå¦‚ 10ï¼‰">
        </div>
        <div class="form-group">
          <label for="arrival-days">ğŸ•’ åˆ°è²¨å¤©æ•¸</label>
          <input type="number" id="arrival-days" placeholder="é ä¼°å¹¾å¤©å¾Œåˆ°è²¨">
        </div>
        <div class="form-group">
          <label for="cost">ğŸ’° å–®ä½æˆæœ¬</label>
          <input type="number" id="cost" required placeholder="å–®ä½æˆæœ¬ï¼ˆå¦‚ 25.5ï¼‰" step="any">
        </div>
        <div class="form-group">
          <label for="shipping">ğŸšš é‹è²»</label>
          <input type="number" id="shipping" placeholder="æœ¬æ¬¡é‹è²»ï¼ˆå¯ç•™ç©ºï¼‰">
        </div>
        <div class="form-group">
          <label for="url">ğŸ“ ç¶²å€/å‚™è¨»</label>
          <input type="text" id="url" placeholder="å¯è¼¸å…¥ç¶²å€æˆ–å‚™è¨»å…§å®¹">
        </div>
        <button type="submit">æ–°å¢ç´€éŒ„</button>
      </form>
    </div>
    <div class="data-section">
      <select id="month-filter"></select>
      <input type="text" id="search" placeholder="æœå°‹é—œéµå­—...">
      <div class="summary">
        è²¨ç‰©ç¸½æˆæœ¬ï¼š$<span id="monthly-goods">0</span><br>
        é‹è²»æˆæœ¬ï¼š$<span id="monthly-shipping">0</span><br>
        ç¸½æˆæœ¬ï¼š$<span id="monthly-total">0</span>
      </div>
      <div class="record-list">
        <table id="records">
          <thead>
            <tr>
              <th>è³¼è²·æ—¥æœŸ</th><th>å“é …</th><th>æ•¸é‡</th><th>åˆ°è²¨å¤©æ•¸</th><th>é ä¼°åˆ°è²¨æ—¥</th>
              <th>æˆæœ¬</th><th>é‹è²»</th><th>ç¶²å€/å‚™è¨»</th><th>å·²é€²è²¨</th><th>åˆªé™¤</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <button onclick="undoLastDelete()"
    style="position:fixed;bottom:10px;left:10px;background:#ffc107;color:black;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;">
    å¾©åŸä¸Šä¸€ç­†åˆªé™¤
  </button>

  <script>
    const form = document.getElementById("purchase-form");
    const tbody = document.querySelector("#records tbody");
    const itemList = document.getElementById("item-list");
    const searchInput = document.getElementById("search");
    const monthFilter = document.getElementById("month-filter");
    const monthlyGoods = document.getElementById("monthly-goods");
    const monthlyShipping = document.getElementById("monthly-shipping");
    const monthlyTotal = document.getElementById("monthly-total");

    let allRecords = [];
    let lastDeleted = null;
    let itemHistory = new Set();

    function generateMonthOptions() {
      monthFilter.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "å…¨éƒ¨æœˆä»½";
      monthFilter.appendChild(optAll);
      const now = new Date();
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = `${d.getFullYear()}-${m}`;
        opt.textContent = opt.value;
        if (i === 0) opt.selected = true;
        monthFilter.appendChild(opt);
      }
    }

    function renderTable() {
      tbody.innerHTML = "";
      let sumGoods = 0, sumShip = 0;
      const q = searchInput.value.toLowerCase();
      const sel = monthFilter.value;
      allRecords.map((r, i) => ({...r, idx: i}))
        .filter(r => {
          const txt = Object.values(r).join(" ").toLowerCase();
          return txt.includes(q) && (sel === "all" || r.date.startsWith(sel));
        })
        .forEach(r => {
          sumGoods += r.cost * r.quantity;
          sumShip += r.shipping;
          const est = r.arrivalDays
            ? new Date(new Date(r.date).getTime() + r.arrivalDays*86400000).toISOString().slice(0,10)
            : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td title="${r.date}">${r.date.slice(5)}</td>
            <td>${r.item}</td>
            <td>${r.quantity}</td>
            <td>${r.arrivalDays||""}</td>
            <td title="${est}">${est.slice(5)}</td>
            <td>$${r.cost.toFixed(2)}</td>
            <td>$${r.shipping.toFixed(2)}</td>
            <td>${r.url? (r.url.startsWith("http")? `<a href="${r.url}" target="_blank">æŸ¥çœ‹</a>`: r.url.replace(/\n/g,"<br>")):""}</td>
            <td><input type="checkbox"></td>
            <td><button class="delete-btn" data-idx="${r.idx}">åˆªé™¤</button></td>
          `;
          tbody.appendChild(tr);
          tr.querySelector(".delete-btn").addEventListener("click", () => {
            lastDeleted = allRecords.splice(r.idx,1)[0];
            renderTable();
          });

          // é›™æ“Šç·¨è¼¯åŠŸèƒ½ï¼Œä¸è®Š
          const mapIdx = {date:0,item:1,quantity:2,arrivalDays:3,cost:5,shipping:6,url:7};
          Object.entries(mapIdx).forEach(([f,ci]) => {
            const cell = tr.children[ci];
            cell.addEventListener("dblclick",()=>{
              const orig = r[f]||"";
              const inp = document.createElement("input");
              inp.type = f==="date" ? "date" : (typeof orig==="number"?"number":"text");
              inp.value = orig;
              inp.style.width = "100%";
              inp.addEventListener("keydown",e=>{
                if(e.key==="Enter") inp.blur();
                if(e.key==="Escape") cell.innerHTML = orig;
              });
              inp.addEventListener("blur",()=>{
                const v = inp.value;
                r[f] = ["cost","shipping","quantity","arrivalDays"].includes(f)? parseFloat(v):v;
                renderTable();
              });
              cell.innerHTML = "";
              cell.appendChild(inp);
              inp.focus();
            });
          });
        });

      monthlyGoods.textContent   = sumGoods.toFixed(2);
      monthlyShipping.textContent = sumShip.toFixed(2);
      monthlyTotal.textContent    = (sumGoods+sumShip).toFixed(2);
    }

    // ä½ çš„ Apps Script Web App URL
    const rawURL = "https://script.google.com/macros/s/AKfycbxUt-CEJUyeg3lOulA5VoaHIFebQcLFtC8eTWT-tTtFdmACe9l4ixsxsrvycJyFqbub_w/exec";
    // AllOrigins å…è²»ä»£ç†å‰ç¶´
    const scriptURL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rawURL);

    async function loadRemoteData() {
      try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        allRecords = data.map(r => ({
          date: r.date,
          item: r.item,
          quantity: Number(r.quantity),
          arrivalDays: Number(r.arrivalDays),
          cost: Number(r.cost),
          shipping: Number(r.shipping),
          url: r.url
        }));
        renderTable();
      } catch(err) {
        console.error("è®€å– Google Sheets å¤±æ•—ï¼š", err);
      }
    }

    form.addEventListener("submit", async e=>{
      e.preventDefault();
      const rec = {
        date: form.date.value,
        item: form.item.value,
        quantity: Number(form.quantity.value),
        arrivalDays: Number(form["arrival-days"].value)||0,
        cost: Number(form.cost.value),
        shipping: Number(form.shipping.value)||0,
        url: form.url.value
      };
      try {
        await fetch(scriptURL, {
          method: "POST",
          mode: "no-cors",
          body: new URLSearchParams(rec)
        });
        form.reset();
        await loadRemoteData();
      } catch(err) {
        console.error("å¯«å…¥ Google Sheets å¤±æ•—ï¼š", err);
      }
    });

    document.addEventListener("DOMContentLoaded", ()=>{
      generateMonthOptions();
      loadRemoteData();
      monthFilter.addEventListener("change", renderTable);
      searchInput.addEventListener("input", renderTable);
    });

    function undoLastDelete(){
      if(!lastDeleted) return alert("æ²’æœ‰å¯å¾©åŸçš„ç´€éŒ„ã€‚");
      allRecords.push(lastDeleted);
      lastDeleted = null;
      renderTable();
    }
  </script>
</body>
</html>
